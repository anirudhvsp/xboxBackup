{% if media %}
<div class="grid gap-2 p-2 media-grid-page">
    {% for item in media %}
    <div class="media-tile relative overflow-hidden aspect-square rounded-lg shadow-md transition-transform duration-300 ease-in-out ghost-loading"
        data-name="{{ item.name }}" data-thumbnail="{{ item.thumbnail }}"
        data-type="{{ item.type }}" data-duration="{{ item.duration if item.type == 'stream' else '' }}"
        {% if item.type == 'stream' %} hx-get="/stream/{{ item.name }}" hx-target="body" hx-push-url="true" {% endif %}>
        
        <div class="image-container">
            <div class="ghost-image h-40 bg-gray-300 rounded-lg transition-opacity duration-300 ease-in-out"></div>
        </div>
        <div class="title-overlay absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t from-black to-transparent text-white opacity-0 transition-opacity duration-300 ease-in-out">
            <p class="title-text text-center text-sm">{{ item.name }}</p>
        </div>
        {% if item.type == 'stream' %}
        <div class="duration-indicator absolute bottom-2 right-2 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded-md transition-opacity duration-300 ease-in-out">{{ item.duration }}</div>
        {% endif %}
        <div class="cached-icon hidden absolute top-1 left-1 w-6 h-6 bg-center bg-no-repeat z-10"></div>
    </div>
    {% endfor %}
</div>

{% if page < total_pages %}
<div class="trigger" hx-get="/media_page/{{ page + 1 }}" hx-trigger="intersect once" hx-swap="outerHTML"></div>
{% endif %}
{% endif %}

<script>
    async function checkCachedVideos() {
        const cacheStorage = await caches.open("video-metadata");
        const cachedResponse = await cacheStorage.keys();

        const cachedVideoIds = cachedResponse.map(request => request.url.split('/').pop());
        const cachedVideos = JSON.parse(localStorage.getItem('video-metadata')) || [];
        const cachedVideoNames = cachedVideos.map(video => video.name);

        const tiles = document.querySelectorAll('.media-tile');
        tiles.forEach(tile => {
            const name = tile.dataset.name;
            if (cachedVideoNames.includes(name) || cachedVideoIds.includes(name)) {
                const cachedIcon = tile.querySelector('.cached-icon');
                cachedIcon.classList.remove('hidden');
                cachedIcon.style.backgroundImage = 'url("/static/icon-check-small.png")';
            }
        });
    }

    function loadActualContent() {
        const tiles = document.querySelectorAll('.media-tile.ghost-loading');
        tiles.forEach(tile => {
            const name = tile.dataset.name;
            const thumbnail = tile.dataset.thumbnail;
            const type = tile.dataset.type;
            const duration = tile.dataset.duration;

            tile.innerHTML = `
                <div class="image-container">
                    <img preload class="lazy-load w-full h-full object-cover rounded-lg" data-src="${thumbnail}" alt="${name}">
                </div>
                <div class="title-overlay">
                    <p class="title-text">${name}</p>
                </div>
                ${type === 'stream' ? `<div class="duration-indicator">${duration}</div>` : ''}
                <div class="cached-icon hidden"></div>
            `;

            tile.classList.remove('ghost-loading');
            tile.classList.add('loading');
        });
        lazyLoadImages();
    }

    function lazyLoadImages() {
        const images = document.querySelectorAll('.media-tile.loading img.lazy-load');
        images.forEach(img => {
            if (img.dataset.src) {
                img.onload = function () {
                    this.style.opacity = 1;
                    this.closest('.media-tile').classList.remove('loading');
                    this.closest('.media-tile').classList.add('loaded');
                };
                img.src = img.dataset.src;
                img.removeAttribute('data-src');
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadActualContent();
        checkCachedVideos();
    });
    document.addEventListener('htmx:load', () => {
        loadActualContent();
        checkCachedVideos();
    });
    document.addEventListener('htmx:afterSwap', () => {
        loadActualContent();
        checkCachedVideos();
    });
</script>
