{% if media %}
<div class="media-grid-page">
    {% for item in media %}
    <div class="media-tile ghost-loading" data-name="{{ item.name }}" data-thumbnail="{{ item.thumbnail }}"
        data-type="{{ item.type }}" data-duration="{{ item.duration if item.type == 'stream' else '' }}" {% if
        item.type=='stream' %} hx-get="/stream/{{ item.name }}" hx-target="body" hx-push-url="true" {% endif %}>
        <div class="image-container">
            <div class="ghost-image"></div>
        </div>
        <div class="title-overlay">
            <p class="title-text">{{ item.name }}</p>
        </div>
        {% if item.type == 'stream' %}
        <div class="duration-indicator">{{ item.duration }}</div>
        {% endif %}
        <div class="cached-icon" style="display: none;"></div>
    </div>
    {% endfor %}
</div>
{% if page < total_pages %} <div class="trigger" hx-get="/media_page/{{ page + 1 }}" hx-trigger="intersect once"
    hx-swap="outerHTML">
    </div>
    {% endif %}
    {% endif %}

    <script>
        async function checkCachedVideos() {
            const cacheStorage = await caches.open("video-metadata");
            const cachedResponse = await cacheStorage.keys();

            // Extracting video IDs from cached responses
            const cachedVideoIds = cachedResponse.map(request => request.url.split('/').pop()); // Adjust based on your URL structure
            const cachedVideos = JSON.parse(localStorage.getItem('video-metadata')) || [];
            const cachedVideoNames = cachedVideos.map(video => video.name);

            const tiles = document.querySelectorAll('.media-tile');
            tiles.forEach(tile => {
                const name = tile.dataset.name;
                if (cachedVideoNames.includes(name) || cachedVideoIds.includes(name)) {
                    const cachedIcon = tile.querySelector('.cached-icon');
                    cachedIcon.style.display = 'block';
                    cachedIcon.style.backgroundImage = 'url("/static/icon-check-small.png")';
                }
            });
        }

        function loadActualContent() {
            const tiles = document.querySelectorAll('.media-tile.ghost-loading');
            tiles.forEach(tile => {
                const name = tile.dataset.name;
                const thumbnail = tile.dataset.thumbnail;
                const type = tile.dataset.type;
                const duration = tile.dataset.duration;

                tile.innerHTML = `
            <div class="image-container">
                <img preload class="lazy-load" data-src="${thumbnail}" alt="${name}">
            </div>
            <div class="title-overlay">
                <p class="title-text">${name}</p>
            </div>
            ${type === 'stream' ? `<div class="duration-indicator">${duration}</div>` : ''}
            <div class="cached-icon" style="display: none;"></div>
        `;

                tile.classList.remove('ghost-loading');
                tile.classList.add('loading');
            });
            lazyLoadImages();
        }

        function lazyLoadImages() {
            const images = document.querySelectorAll('.media-tile.loading img.lazy-load');
            images.forEach(img => {
                if (img.dataset.src) {
                    img.onload = function () {
                        this.style.opacity = 1;
                        this.closest('.media-tile').classList.remove('loading');
                        this.closest('.media-tile').classList.add('loaded');
                    };
                    img.src = img.dataset.src;
                    img.removeAttribute('data-src');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadActualContent();
            checkCachedVideos();
        });
        document.addEventListener('htmx:load', () => {
            loadActualContent();
            checkCachedVideos();
        });
        document.addEventListener('htmx:afterSwap', () => {
            loadActualContent();
            checkCachedVideos();
        });
    </script>