<head>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>

{% if media %}
<div
    class="grid gap-2 p-2 grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-8 xl:grid-cols-auto xl:grid-cols-min-[160px]">
    {% for item in media %}
    <div class="media-tile ghost-loading aspect-square relative overflow-hidden rounded-lg shadow-md transition-transform duration-300 ease-in-out hover:scale-105"
        data-name="{{ item.name }}" data-thumbnail="{{ item.thumbnail }}" data-type="{{ item.type }}"
        data-duration="{{ item.duration if item.type == 'stream' else '' }}" {% if item.type=='stream' %}
        hx-get="/stream/{{ item.name }}" hx-trigger="click" hx-target="body" hx-push-url="true" hx-preload="mouseover"
        {% endif %}>
        <div class="image-container">
            <div
                class="ghost-image bg-gray-200 opacity-0 transition-opacity duration-300 ease-in-out rounded-lg h-full">
            </div>
        </div>
        <div
            class="title-overlay absolute bottom-0 left-0 right-0 p-2.5 bg-gradient-to-t from-black to-transparent text-white opacity-0 transition-opacity duration-300 ease-in-out">
            <p class="title-text m-0 text-sm text-center">{{ item.name }}</p>
        </div>
        {% if item.type == 'stream' %}
        <div
            class="duration-indicator absolute bottom-1 right-1 bg-black bg-opacity-70 text-white p-1 rounded text-xs transition-opacity duration-300 ease-in-out">
            {{ item.duration }}</div>
        {% endif %}
        <div class="cached-icon hidden absolute top-1 left-1 w-6 h-6 bg-contain bg-no-repeat bg-center z-10"></div>
    </div>
    {% endfor %}
</div>
{% if page < total_pages %} <div class="trigger" hx-get="/media_page/{{ page + 1 }}" hx-trigger="intersect once"
    hx-swap="outerHTML">
    </div>
    {% endif %}
    {% endif %}

    <script>
        async function checkCachedVideos() {
            const cacheStorage = await caches.open("video-metadata");
            const cachedResponse = await cacheStorage.keys();

            // Extracting video IDs from cached responses
            const cachedVideoIds = cachedResponse.map(request => request.url.split('/').pop()); // Adjust based on your URL structure
            const cachedVideos = JSON.parse(localStorage.getItem('video-metadata')) || [];
            const cachedVideoNames = cachedVideos.map(video => video.name);

            const tiles = document.querySelectorAll('.media-tile');
            tiles.forEach(tile => {
                const name = tile.dataset.name;
                if (cachedVideoNames.includes(name) || cachedVideoIds.includes(name)) {
                    const cachedIcon = tile.querySelector('.cached-icon');
                    cachedIcon.style.display = 'block';
                    cachedIcon.style.backgroundImage = 'url("/static/icon-check-small.png")';
                }
            });
        }

        function loadActualContent() {
            const tiles = document.querySelectorAll('.media-tile.ghost-loading');
            tiles.forEach(tile => {
                const name = tile.dataset.name;
                const thumbnail = tile.dataset.thumbnail;
                const type = tile.dataset.type;
                const duration = tile.dataset.duration;

                tile.innerHTML = `
            <div class="image-container">
                <img preload class="lazy-load" data-src="${thumbnail}" alt="${name}">
            </div>
            <div class="title-overlay">
                <p class="title-text">${name}</p>
            </div>
            ${type === 'stream' ? `<div class="duration-indicator">${duration}</div>` : ''}
            <div class="cached-icon" style="display: none;"></div>
        `;

                tile.classList.remove('ghost-loading');
                tile.classList.add('loading');
            });
            lazyLoadImages();
        }

        function lazyLoadImages() {
            const images = document.querySelectorAll('.media-tile.loading img.lazy-load');
            images.forEach(img => {
                if (img.dataset.src) {
                    img.onload = function () {
                        this.style.opacity = 1;
                        this.closest('.media-tile').classList.remove('loading');
                        this.closest('.media-tile').classList.add('loaded');
                    };
                    img.src = img.dataset.src;
                    img.removeAttribute('data-src');
                }
            });
        }

        function handlePreloadedContent() {
            document.body.addEventListener('htmx:afterOnLoad', function(event) {
                if (event.detail.elt.classList.contains('media-tile')) {
                    const preloadedContent = event.detail.xhr.response;
                    localStorage.setItem('preloaded-' + event.detail.elt.dataset.name, preloadedContent);
                }
            });

            document.body.addEventListener('htmx:beforeRequest', function(event) {
                if (event.detail.elt.classList.contains('media-tile')) {
                    const preloadedContent = localStorage.getItem('preloaded-' + event.detail.elt.dataset.name);
                    if (preloadedContent) {
                        event.preventDefault();
                        document.body.innerHTML = preloadedContent;
                        history.pushState(null, '', event.detail.path);
                        localStorage.removeItem('preloaded-' + event.detail.elt.dataset.name);
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadActualContent();
            checkCachedVideos();
            handlePreloadedContent();
        });
        document.addEventListener('htmx:load', () => {
            loadActualContent();
            checkCachedVideos();
            handlePreloadedContent();
        });
        document.addEventListener('htmx:afterSwap', () => {
            loadActualContent();
            checkCachedVideos();
            handlePreloadedContent();
        });
    </script>